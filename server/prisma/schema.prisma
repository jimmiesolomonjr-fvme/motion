generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STEPPER
  BADDIE
}

enum ContentType {
  TEXT
  VOICE
  IMAGE
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
}

enum MoveStatus {
  OPEN
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum MoveCategory {
  DINNER
  DRINKS
  ADVENTURE
  GROUP
  CONCERT
  OTHER
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone        String?
  passwordHash String
  role         Role
  isPremium    Boolean  @default(false)
  isVerified   Boolean  @default(false)
  isBanned     Boolean  @default(false)
  isMuted      Boolean  @default(false)
  isHidden     Boolean  @default(false)
  isDummy      Boolean  @default(false)
  isAdmin      Boolean  @default(false)
  notificationsEnabled Boolean @default(true)
  showVibeInFeed       Boolean @default(true)
  afterDarkEnabled     Boolean @default(false)
  referralCode String?  @unique
  referredBy   String?
  lastOnline   DateTime @default(now())
  locationLat  Float?
  locationLng  Float?
  createdAt    DateTime @default(now())

  profile      Profile?
  subscription Subscription?

  sentLikes     Like[]    @relation("LikerLikes")
  receivedLikes Like[]    @relation("LikedLikes")
  matches1      Match[]   @relation("MatchUser1")
  matches2      Match[]   @relation("MatchUser2")
  conversations1 Conversation[] @relation("ConvUser1")
  conversations2 Conversation[] @relation("ConvUser2")
  sentMessages  Message[]
  messageReactions MessageReaction[]
  pushSubscriptions PushSubscription[]
  sentReports   Report[]  @relation("Reporter")
  receivedReports Report[] @relation("Reported")
  blocks        Block[]   @relation("Blocker")
  blockedBy     Block[]   @relation("Blocked")
  vibeAnswers   VibeAnswer[]
  moves             Move[]         @relation("StepperMoves")
  selectedForMoves  Move[]         @relation("SelectedBaddieMoves")
  moveInterests     MoveInterest[]
  moveParticipations MoveParticipant[]
  savedMoves        SavedMove[]
  hiddenFrom    HiddenPair[] @relation("HiddenUser1")
  hiddenTo      HiddenPair[] @relation("HiddenUser2")
  profileViews     ProfileView[] @relation("Viewer")
  profileViewedBy  ProfileView[] @relation("Viewed")
  notifications    Notification[]
  profilePrompts   ProfilePrompt[]
  stories          Story[]
  storyViews       StoryView[] @relation("storyViews")
  storyLikes       StoryLike[] @relation("storyLikes")

  vibeStreak           Int       @default(0)
  vibeLastAnsweredDate DateTime?
  vibeMatchShownAt     DateTime?

  @@index([role, isBanned, isHidden, isDummy])
  @@index([lastOnline])
  @@index([createdAt])
  @@index([referredBy])
}

model Profile {
  id             String   @id @default(uuid())
  userId         String   @unique
  displayName    String
  bio            String?
  age            Int
  city           String
  photos         Json     @default("[]")
  lookingFor     String?
  height         String?
  weight         String?
  occupation     String?
  lookingForTags Json     @default("[]")
  songTitle      String?
  songArtist     String?
  songPreviewUrl String?
  songArtworkUrl String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Conversation {
  id            String   @id @default(uuid())
  user1Id       String
  user2Id       String
  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())

  user1    User      @relation("ConvUser1", fields: [user1Id], references: [id])
  user2    User      @relation("ConvUser2", fields: [user2Id], references: [id])
  messages Message[]

  @@unique([user1Id, user2Id])
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  contentType    ContentType @default(TEXT)
  readAt         DateTime?
  replyToId      String?
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])
  replyTo      Message?     @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies      Message[]    @relation("MessageReplies")
  reactions    MessageReaction[]
}

model Like {
  id        String   @id @default(uuid())
  likerId   String
  likedId   String
  createdAt DateTime @default(now())

  liker User @relation("LikerLikes", fields: [likerId], references: [id])
  liked User @relation("LikedLikes", fields: [likedId], references: [id])

  @@unique([likerId, likedId])
}

model Match {
  id        String   @id @default(uuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())

  user1 User @relation("MatchUser1", fields: [user1Id], references: [id])
  user2 User @relation("MatchUser2", fields: [user2Id], references: [id])

  @@unique([user1Id, user2Id])
}

model Report {
  id         String       @id @default(uuid())
  reporterId String
  reportedId String
  reason     String
  details    String?
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())

  reporter User @relation("Reporter", fields: [reporterId], references: [id])
  reported User @relation("Reported", fields: [reportedId], references: [id])
}

model Block {
  id        String   @id @default(uuid())
  blockerId String
  blockedId String
  createdAt DateTime @default(now())

  blocker User @relation("Blocker", fields: [blockerId], references: [id])
  blocked User @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
}

model VibeQuestion {
  id              String   @id @default(uuid())
  questionText    String
  category        String
  isActive        Boolean  @default(true)
  responseOptions Json?    @default("[\"Yes\", \"No\"]")
  createdAt       DateTime @default(now())

  answers VibeAnswer[]
}

model VibeAnswer {
  id         String   @id @default(uuid())
  userId     String
  questionId String
  answer     Boolean
  answeredAt DateTime @default(now())

  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question VibeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
}

model Subscription {
  id                   String   @id @default(uuid())
  userId               String   @unique
  stripeCustomerId     String?
  stripeSubscriptionId String?
  status               String   @default("inactive")
  currentPeriodEnd     DateTime?
  createdAt            DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Move {
  id               String        @id @default(uuid())
  stepperId        String
  title            String
  description      String
  date             DateTime
  location         String
  maxInterest      Int           @default(10)
  isActive         Boolean       @default(true)
  status           MoveStatus    @default(OPEN)
  category         MoveCategory?
  photo            String?
  isAnytime        Boolean       @default(false)
  selectedBaddieId String?
  dressCode        String?
  playlistLink     String?
  stepperOnMyWay   Boolean       @default(false)
  baddieOnMyWay    Boolean       @default(false)
  createdAt        DateTime      @default(now())

  stepper        User           @relation("StepperMoves", fields: [stepperId], references: [id])
  selectedBaddie User?          @relation("SelectedBaddieMoves", fields: [selectedBaddieId], references: [id])
  interests      MoveInterest[]
  participants   MoveParticipant[]
  savedBy        SavedMove[]

  @@index([status, date])
  @@index([stepperId])
  @@index([selectedBaddieId])
}

model MoveInterest {
  id              String   @id @default(uuid())
  moveId          String
  baddieId        String
  message         String?
  counterProposal String?
  createdAt       DateTime @default(now())

  move   Move @relation(fields: [moveId], references: [id], onDelete: Cascade)
  baddie User @relation(fields: [baddieId], references: [id])

  @@unique([moveId, baddieId])
}

model MoveParticipant {
  id        String   @id @default(uuid())
  moveId    String
  baddieId  String
  onMyWay   Boolean  @default(false)
  createdAt DateTime @default(now())

  move   Move @relation(fields: [moveId], references: [id], onDelete: Cascade)
  baddie User @relation(fields: [baddieId], references: [id])

  @@unique([moveId, baddieId])
  @@index([moveId])
}

model SavedMove {
  id        String   @id @default(uuid())
  userId    String
  moveId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  move Move @relation(fields: [moveId], references: [id], onDelete: Cascade)

  @@unique([userId, moveId])
}

model HiddenPair {
  id        String   @id @default(uuid())
  user1Id   String
  user2Id   String
  reason    String?
  createdAt DateTime @default(now())

  user1 User @relation("HiddenUser1", fields: [user1Id], references: [id])
  user2 User @relation("HiddenUser2", fields: [user2Id], references: [id])

  @@unique([user1Id, user2Id])
}

model AppSetting {
  key   String @id
  value String
}

model ProfileView {
  id        String   @id @default(uuid())
  viewerId  String
  viewedId  String
  createdAt DateTime @default(now())

  viewer User @relation("Viewer", fields: [viewerId], references: [id], onDelete: Cascade)
  viewed User @relation("Viewed", fields: [viewedId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  title     String
  body      String
  data      Json?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfilePrompt {
  id        String   @id @default(uuid())
  userId    String
  prompt    String
  answer    String
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, prompt])
}

model Story {
  id        String    @id @default(uuid())
  userId    String
  photo     String
  caption   String?
  expiresAt DateTime
  createdAt DateTime  @default(now())

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  views StoryView[]
  likes StoryLike[]
}

model StoryView {
  id        String   @id @default(uuid())
  storyId   String
  viewerId  String
  createdAt DateTime @default(now())

  story  Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewer User  @relation("storyViews", fields: [viewerId], references: [id], onDelete: Cascade)

  @@unique([storyId, viewerId])
}

model StoryLike {
  id        String   @id @default(uuid())
  storyId   String
  userId    String
  createdAt DateTime @default(now())

  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user  User  @relation("storyLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
